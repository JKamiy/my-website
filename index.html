<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trip.com Style Checkout</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #F0F2F5;
            -webkit-tap-highlight-color: transparent;
        }

        .trip-blue { color: #287DFA; }
        .bg-trip-blue { background-color: #287DFA; }
        .border-trip-blue { border-color: #287DFA; }

        /* Page Transitions */
        .slide-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .page-step {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            background-color: #F0F2F5;
            display: flex;
            flex-direction: column;
        }

        .step-active { transform: translateX(0); opacity: 1; z-index: 10; }
        .step-next { transform: translateX(100%); opacity: 0; z-index: 5; }
        .step-prev { transform: translateX(-100%); opacity: 0; z-index: 5; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Method Selector Styles */
        .method-card { transition: all 0.2s ease; overflow: hidden; }
        .method-header { transition: background-color 0.2s ease; }
        .method-body { max-height: 0; opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }
        
        .method-selected { border-color: #287DFA; background-color: #fff; box-shadow: 0 4px 6px -1px rgba(40, 125, 250, 0.1); }
        .method-selected .method-header { background-color: #F0F7FF; color: #287DFA; }
        .method-selected .method-body { max-height: 800px; opacity: 1; padding-bottom: 1rem; }

        /* Input Styles */
        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-field:focus { border-color: #287DFA; }
    </style>
</head>
<body class="text-gray-800 antialiased h-screen overflow-hidden flex flex-col">

    <!-- MAIN CONTAINER -->
    <div class="w-full max-w-md mx-auto bg-white h-full flex flex-col shadow-2xl relative">

        <!-- HEADER -->
        <header class="bg-white px-4 py-3 flex items-center justify-between z-30 shadow-sm shrink-0">
            <button onclick="handleBack()" class="text-gray-600 text-xl p-2 hover:bg-gray-100 rounded-full transition w-10 h-10 flex items-center justify-center">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h1 class="text-lg font-bold text-gray-800" id="header-title">Checkout</h1>
            <div class="w-10"></div> 
        </header>

        <!-- SLIDER CONTAINER -->
        <div class="slide-container flex-1 relative">

            <!-- === STEP 1: PAYMENT METHOD SELECTION === -->
            <div id="step-1" class="page-step step-active">
                <!-- Timer -->
                <div class="bg-[#FFF8E1] text-[#8A6D3B] text-sm px-4 py-2 flex items-center justify-center gap-2 shrink-0">
                    <i class="fa-regular fa-clock"></i>
                    <span>Pay within <b class="timer-display">14:59</b></span>
                </div>

                <!-- Content -->
                <div class="flex-1 p-4 overflow-y-auto scroll-smooth pb-20">
                    
                    <!-- Amount Summary -->
                    <div class="mb-6 text-center">
                        <p class="text-gray-500 text-xs uppercase tracking-wide mb-1">Total Amount</p>
                        <div class="text-3xl font-bold trip-blue">
                            <span class="text-xl align-top">$</span>1,248.50
                        </div>
                    </div>

                    <!-- Method List -->
                    <div class="space-y-3">

                        <!-- Method 1: Bank Card (Moved to Top - Default) -->
                        <div id="method-card" class="method-card method-selected border border-gray-200 rounded-xl" onclick="selectMethod('card')">
                            <div class="method-header p-4 flex items-center justify-between cursor-pointer">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                        <i class="fa-regular fa-credit-card"></i>
                                    </div>
                                    <div>
                                        <div class="font-bold text-sm">Credit / Debit Card</div>
                                        <div class="flex gap-1 mt-0.5">
                                            <i class="fa-brands fa-cc-visa text-gray-400 text-xs"></i>
                                            <i class="fa-brands fa-cc-mastercard text-gray-400 text-xs"></i>
                                            <i class="fa-brands fa-cc-amex text-gray-400 text-xs"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="w-4 h-4 rounded-full border border-gray-300 radio-indicator flex items-center justify-center">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full hidden selected-dot"></div>
                                </div>
                            </div>

                            <div class="method-body px-4">
                                <div class="pt-2 border-t border-gray-100 space-y-3">
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Card Number</label>
                                        <div class="relative">
                                            <input type="tel" placeholder="0000 0000 0000 0000" class="input-field pl-10" maxlength="19">
                                            <i class="fa-regular fa-credit-card absolute left-3.5 top-3.5 text-gray-400"></i>
                                        </div>
                                    </div>
                                    <div class="flex gap-3">
                                        <div class="flex-1">
                                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Expiry</label>
                                            <input type="tel" placeholder="MM/YY" class="input-field text-center" maxlength="5">
                                        </div>
                                        <div class="flex-1">
                                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">CVV</label>
                                            <input type="tel" placeholder="123" class="input-field text-center" maxlength="3">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Cardholder Name</label>
                                        <input type="text" placeholder="YOUR NAME" class="input-field uppercase">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Method 2: Apple Pay (No Button Inside) -->
                        <div id="method-apple" class="method-card border border-gray-200 rounded-xl" onclick="selectMethod('apple')">
                            <div class="method-header p-4 flex items-center justify-between cursor-pointer">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center text-white">
                                        <i class="fa-brands fa-apple"></i>
                                    </div>
                                    <div class="font-bold text-sm">Apple Pay</div>
                                </div>
                                <div class="w-4 h-4 rounded-full border border-gray-300 radio-indicator flex items-center justify-center">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full hidden selected-dot"></div>
                                </div>
                            </div>
                            
                            <div class="method-body px-4">
                                <div class="pt-2 pb-2">
                                    <p class="text-xs text-gray-500 mb-1">Use Face ID or Touch ID to verify payment securely.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Method 3: Crypto -->
                        <div id="method-crypto" class="method-card border border-gray-200 rounded-xl" onclick="selectMethod('crypto')">
                            <div class="method-header p-4 flex items-center justify-between cursor-pointer">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                                        <i class="fa-solid fa-coins"></i>
                                    </div>
                                    <div>
                                        <div class="font-bold text-sm">Stable Coin</div>
                                        <div class="text-[10px] text-gray-400">USDT / USDC</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="bg-red-100 text-red-600 text-[9px] font-bold px-1.5 py-0.5 rounded">RECOMMENDED</span>
                                    <div class="w-4 h-4 rounded-full border border-gray-300 radio-indicator flex items-center justify-center">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full hidden selected-dot"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="method-body px-4">
                                <!-- Config Section for Crypto -->
                                <div class="pt-2 border-t border-blue-100/50">
                                    <label class="text-xs font-bold text-gray-500 block mb-2 mt-2">Select Currency</label>
                                    <div class="flex bg-gray-100 p-1 rounded-lg mb-4">
                                        <button onclick="selectCoin(event, 'USDT')" id="btn-usdt" class="flex-1 py-2 rounded-md text-xs font-bold shadow-sm bg-white text-blue-600 transition-all flex items-center justify-center gap-1">
                                            <img src="https://cryptologos.cc/logos/tether-usdt-logo.png" class="w-4 h-4" alt="USDT"> USDT
                                        </button>
                                        <button onclick="selectCoin(event, 'USDC')" id="btn-usdc" class="flex-1 py-2 rounded-md text-xs font-semibold text-gray-500 hover:text-gray-700 transition-all flex items-center justify-center gap-1">
                                            <img src="https://cryptologos.cc/logos/usd-coin-usdc-logo.png" class="w-4 h-4" alt="USDC"> USDC
                                        </button>
                                    </div>

                                    <label class="text-xs font-bold text-gray-500 block mb-2">Select Network</label>
                                    <div class="grid grid-cols-2 gap-2" id="chain-container">
                                        <!-- Chains injected by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Footer Step 1 -->
                <div class="bg-white border-t border-gray-200 p-4 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] relative z-20">
                    <button id="main-action-btn" onclick="handleMainAction()" class="w-full bg-trip-blue text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-[0.98] transition-transform flex justify-center items-center gap-2">
                        Pay $1,248.50
                    </button>
                </div>
            </div>

            <!-- === STEP 2: CRYPTO EXECUTION (Only for Crypto) === -->
            <div id="step-2" class="page-step step-next">
                <!-- Timer Mini -->
                <div class="bg-blue-50 text-blue-600 text-xs px-4 py-1.5 flex items-center justify-center gap-2 shrink-0 border-b border-blue-100">
                    <i class="fa-regular fa-clock"></i>
                    <span>Time remaining: <b class="timer-display">14:59</b></span>
                </div>

                <!-- Method Tabs -->
                <div class="bg-white px-4 pt-2 shadow-sm z-10 shrink-0">
                    <div class="flex border-b border-gray-200">
                        <button onclick="setPaymentMode('scan')" id="tab-scan" class="flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-colors">Scan QR</button>
                        <button onclick="setPaymentMode('manual')" id="tab-manual" class="flex-1 py-3 text-sm font-semibold text-gray-500 border-b-2 border-transparent transition-colors">Verify & Transfer</button>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="flex-1 overflow-y-auto bg-white p-4 relative">
                    
                    <!-- MODE A: Scan QR -->
                    <div id="view-scan" class="flex flex-col items-center justify-center h-full py-2 fade-in">
                        <div class="bg-white p-4 border border-gray-200 rounded-2xl shadow-sm mb-6 relative">
                            <!-- Enlarged QR Code -->
                            <img id="qr-image" src="" alt="QR Code" class="w-64 h-64 rounded-lg object-contain bg-gray-50">
                            <div class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 hidden" id="qr-loader">
                                <div class="loader w-8 h-8 border-4"></div>
                            </div>
                        </div>
                        
                        <!-- Enlarged Address Box -->
                        <div class="w-full bg-gray-50 rounded-xl p-4 flex items-center justify-between border border-gray-200 mb-2 shadow-sm">
                            <div class="flex flex-col overflow-hidden mr-3">
                                <span class="text-xs text-gray-400 uppercase font-bold mb-1">Deposit Address</span>
                                <span id="scan-address-text" class="text-base font-mono text-gray-800 truncate font-bold tracking-tight">...</span>
                            </div>
                            <!-- Enlarged Copy Button -->
                            <button onclick="copyAddress()" class="text-blue-600 bg-white border border-gray-200 w-12 h-12 flex items-center justify-center rounded-xl hover:bg-blue-50 shadow-sm transition active:scale-95">
                                <i class="fa-regular fa-copy text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- MODE B: Manual Verification -->
                    <div id="view-manual" class="hidden h-full flex flex-col pt-2 fade-in">
                        <div id="manual-step-1" class="flex-1">
                            <div class="bg-blue-50 rounded-lg p-3 mb-4 text-xs text-blue-800 leading-relaxed border border-blue-100">
                                <strong class="block mb-1"><i class="fa-solid fa-shield-halved mr-1"></i> Security Check</strong>
                                Verify your sending wallet address to ensure refund safety and prevent fraud.
                            </div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Your Wallet Address</label>
                            <textarea id="user-wallet-input" placeholder="Paste your wallet address here..." class="w-full h-24 border border-gray-300 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500 resize-none mb-4 bg-gray-50"></textarea>
                            <button onclick="verifyWallet()" id="verify-btn" class="w-full py-3 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-900 transition shadow-sm">
                                Verify Wallet
                            </button>
                        </div>

                        <div id="manual-step-2" class="hidden flex-1">
                            <div class="flex items-center justify-center gap-2 text-green-600 text-sm font-bold mb-6 bg-green-50 py-2 rounded border border-green-100">
                                <i class="fa-solid fa-check-circle"></i> Wallet Verified
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs text-gray-400 uppercase font-bold">Network</label>
                                    <div class="font-bold text-gray-800 flex items-center gap-2">
                                        <span id="summary-chain">TRC20</span>
                                        <span class="bg-gray-100 text-gray-500 text-[10px] px-2 py-0.5 rounded-full border border-gray-200">Exact Match Required</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400 uppercase font-bold">Deposit Address</label>
                                    <div class="flex gap-2 mt-1">
                                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-base font-mono text-gray-700 break-all flex-1 leading-relaxed" id="deposit-address">...</div>
                                        <button onclick="copyAddress()" class="bg-white border border-gray-200 text-blue-600 rounded-lg w-12 flex items-center justify-center shrink-0 shadow-sm active:bg-gray-50">
                                            <i class="fa-regular fa-copy text-lg"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Step 2 -->
                <div class="bg-white border-t border-gray-200 p-4 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
                    <div class="bg-red-50 border border-red-100 text-red-600 text-[11px] p-2.5 rounded-lg mb-3 text-center leading-tight">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                        Only send <strong id="warn-coin">USDT</strong> via <strong id="warn-chain">TRC20</strong>. Other assets will be lost.
                    </div>
                    <button onclick="simulatePayment()" class="w-full bg-trip-blue text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-[0.98] transition-transform flex justify-center items-center gap-2">
                        I Have Paid
                    </button>
                </div>
            </div>
        </div>

        <!-- OVERLAYS -->
        <div id="toast" class="absolute top-16 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs py-2 px-4 rounded-full shadow-lg opacity-0 transition-opacity z-50 flex items-center gap-2 pointer-events-none">
            <i class="fa-solid fa-check text-green-400"></i>
            <span id="toast-msg">Copied</span>
        </div>

        <!-- NEW: Pending Information Overlay -->
        <div id="payment-pending-info" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center hidden fade-in p-6 text-center">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-6 text-blue-500 text-2xl">
                <i class="fa-solid fa-hourglass-start animate-pulse"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Payment Submitted</h2>
            <p class="text-gray-500 text-sm mb-6 max-w-xs">We are verifying your transaction on the blockchain. This usually takes <strong class="text-gray-800">1-5 minutes</strong>.</p>
            
            <div class="bg-orange-50 border border-orange-100 rounded-xl p-4 text-left w-full mb-8">
                <div class="flex gap-3">
                    <i class="fa-solid fa-triangle-exclamation text-orange-500 mt-0.5"></i>
                    <div class="text-xs text-orange-700 leading-relaxed">
                        <strong class="block mb-1 text-orange-800">Important Warning</strong>
                        Please do NOT pay again. Duplicate payments will be refunded automatically, but the received amount will be less due to network gas fees being deducted.
                    </div>
                </div>
            </div>

            <p class="text-xs text-gray-400 mt-4">You will be redirected automatically...</p>
        </div>

        <!-- Processing Spinner (Used for short transitions) -->
        <div id="payment-processing" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center hidden">
            <div class="w-12 h-12 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
            <h2 class="font-bold text-gray-800">Processing</h2>
            <p class="text-gray-500 text-xs mt-1">Securely verifying transaction...</p>
        </div>

        <!-- Success Screen -->
        <div id="payment-success" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center hidden fade-in px-6">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-500 text-3xl">
                <i class="fa-solid fa-check"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Payment Successful!</h2>
            <p class="text-gray-500 text-xs text-center mb-8">Your booking has been confirmed.</p>
            <button onclick="location.reload()" class="w-full border border-trip-blue text-blue-600 font-bold py-3 rounded-xl">Return to Payment Home</button>
        </div>

    </div>

    <script>
        // --- Configuration ---
        const config = {
            USDT: {
                chains: [
                    { name: 'TRC20',    fee: '~$0.8',  recommended: true,  address: 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t' },
                    { name: 'ERC20',    fee: '~$4.5',  recommended: false, address: '0xdAC17F958D2ee523a2206206994597C13D831ec7' },
                    { name: 'BEP20',    fee: '~$0.15', recommended: false, address: '0x55d398326f99059fF775485246999027B3197955' },
                    { name: 'SOL',      fee: '<$0.01', recommended: true,  address: 'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB' },
                    { name: 'POLYGON',  fee: '<$0.02', recommended: false, address: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F' },
                    { name: 'ARBITRUM', fee: '~$0.10', recommended: false, address: '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9' },
                    { name: 'OPTIMISM', fee: '~$0.12', recommended: false, address: '0x94b008aA00579c1307B0EF2c499aD98a8ce98e26' },
                    { name: 'AVAX-C',   fee: '~$0.20', recommended: false, address: '0x9702230A8Ea53601f5cD2dc00fDBc13d4dF4A8c7' }
                ]
            },
            USDC: {
                chains: [
                    { name: 'ERC20',    fee: '~$4.5',  recommended: false, address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48' },
                    { name: 'SOL',      fee: '<$0.01', recommended: true,  address: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v' },
                    { name: 'POLYGON',  fee: '<$0.02', recommended: true,  address: '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174' },
                    { name: 'BEP20',    fee: '~$0.15', recommended: false, address: '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d' },
                    { name: 'ARBITRUM', fee: '~$0.10', recommended: false, address: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831' },
                    { name: 'OPTIMISM', fee: '~$0.12', recommended: false, address: '0x7F5c764cBc14f9669B88837ca1490cCa17c31607' },
                    { name: 'AVAX-C',   fee: '~$0.20', recommended: false, address: '0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E' }
                ]
            }
        };

        let state = {
            step: 1,
            method: 'card', // Default is now Card
            coin: 'USDT',
            chain: config.USDT.chains[0].name,
            mode: 'scan',
            address: config.USDT.chains[0].address,
            walletVerified: false
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            startTimer(15 * 60);
            renderChains();
            updateLabels();
            // Initial selection UI update
            selectMethod('card');
        });

        // --- Method Selection Logic ---
        function selectMethod(method) {
            state.method = method;

            // 1. UI Visual Toggle
            const methods = ['card', 'apple', 'crypto'];
            methods.forEach(m => {
                const el = document.getElementById(`method-${m}`);
                const dot = el.querySelector('.selected-dot');
                if (m === method) {
                    el.classList.add('method-selected');
                    el.classList.remove('border-gray-200');
                    dot.classList.remove('hidden');
                } else {
                    el.classList.remove('method-selected');
                    el.classList.add('border-gray-200');
                    dot.classList.add('hidden');
                }
            });

            // 2. Button Logic Update
            const btn = document.getElementById('main-action-btn');
            if (method === 'crypto') {
                btn.innerHTML = 'Next <i class="fa-solid fa-arrow-right text-sm"></i>';
                btn.classList.add('bg-trip-blue');
                btn.classList.remove('bg-black');
            } else if (method === 'apple') {
                btn.innerText = 'Pay $1,248.50 with Apple Pay';
                btn.classList.remove('bg-trip-blue');
                btn.classList.add('bg-black');
            } else {
                btn.innerText = 'Pay $1,248.50';
                btn.classList.add('bg-trip-blue');
                btn.classList.remove('bg-black');
            }
        }

        function handleMainAction() {
            if (state.method === 'crypto') {
                goToStep(2);
            } else {
                // Direct Payment Simulation for Card/Apple
                simulatePayment(true); 
            }
        }

        // --- Navigation Logic ---
        function goToStep(step) {
            const s1 = document.getElementById('step-1');
            const s2 = document.getElementById('step-2');
            const title = document.getElementById('header-title');
            
            state.step = step;

            if (step === 1) {
                s1.classList.remove('step-prev');
                s1.classList.add('step-active');
                s2.classList.remove('step-active');
                s2.classList.add('step-next');
                title.innerText = 'Checkout';
            } else {
                s1.classList.remove('step-active');
                s1.classList.add('step-prev');
                s2.classList.remove('step-next');
                s2.classList.add('step-active');
                title.innerText = 'Crypto Payment';
                updateAddress();
            }
        }

        function handleBack() {
            if (state.step === 2) {
                goToStep(1);
            } else {
                alert("Back to Merchant App");
            }
        }

        // --- Crypto Logic ---
        function selectCoin(e, coin) {
            e.stopPropagation();
            state.coin = coin;
            const defaultChain = config[coin].chains[0];
            state.chain = defaultChain.name;
            state.address = defaultChain.address;
            
            // Update UI Buttons
            document.getElementById('btn-usdt').className = coin === 'USDT' 
                ? "flex-1 py-2 rounded-md text-xs font-bold shadow-sm bg-white text-blue-600 transition-all flex items-center justify-center gap-1"
                : "flex-1 py-2 rounded-md text-xs font-semibold text-gray-500 hover:text-gray-700 transition-all flex items-center justify-center gap-1";
                
            document.getElementById('btn-usdc').className = coin === 'USDC'
                ? "flex-1 py-2 rounded-md text-xs font-bold shadow-sm bg-white text-blue-600 transition-all flex items-center justify-center gap-1"
                : "flex-1 py-2 rounded-md text-xs font-semibold text-gray-500 hover:text-gray-700 transition-all flex items-center justify-center gap-1";

            renderChains();
            updateLabels();
        }

        function selectChain(e, chainName) {
            e.stopPropagation();
            state.chain = chainName;
            state.address = config[state.coin].chains.find(c => c.name === chainName).address;
            renderChains();
            updateLabels();
        }

        function renderChains() {
            const container = document.getElementById('chain-container');
            container.innerHTML = '';

            config[state.coin].chains.forEach(item => {
                const btn = document.createElement('div');
                const isSelected = state.chain === item.name;
                
                btn.onclick = (e) => selectChain(e, item.name);
                
                btn.className = `relative cursor-pointer rounded-lg p-2 border transition-all flex items-center justify-between ${
                    isSelected 
                    ? 'border-trip-blue bg-blue-50 ring-1 ring-blue-100' 
                    : 'border-gray-200 bg-white hover:bg-gray-50'
                }`;

                let badge = item.recommended 
                    ? `<span class="bg-red-500 text-white text-[8px] font-bold px-1 py-0.5 rounded ml-1">BEST</span>` 
                    : '';

                btn.innerHTML = `
                    <div class="flex items-center w-full overflow-hidden">
                        <div class="w-3 h-3 rounded-full border border-gray-300 flex items-center justify-center mr-2 shrink-0 ${isSelected ? 'border-blue-500 bg-blue-500' : ''}">
                            ${isSelected ? '<div class="w-1 h-1 bg-white rounded-full"></div>' : ''}
                        </div>
                        <div class="truncate">
                            <div class="flex items-center">
                                <span class="text-xs font-bold text-gray-800 truncate">${item.name}</span>
                                ${badge}
                            </div>
                            <div class="text-[9px] text-gray-400 truncate">${item.fee}</div>
                        </div>
                    </div>
                `;
                container.appendChild(btn);
            });
        }

        // --- Shared Logic ---
        function setPaymentMode(mode) {
            state.mode = mode;
            const scanTab = document.getElementById('tab-scan');
            const manualTab = document.getElementById('tab-manual');
            const scanView = document.getElementById('view-scan');
            const manualView = document.getElementById('view-manual');

            if (mode === 'scan') {
                scanTab.className = "flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-colors";
                manualTab.className = "flex-1 py-3 text-sm font-semibold text-gray-500 border-b-2 border-transparent transition-colors";
                scanView.classList.remove('hidden');
                manualView.classList.add('hidden');
            } else {
                scanTab.className = "flex-1 py-3 text-sm font-semibold text-gray-500 border-b-2 border-transparent transition-colors";
                manualTab.className = "flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-colors";
                scanView.classList.add('hidden');
                manualView.classList.remove('hidden');
            }
        }

        function verifyWallet() {
            const input = document.getElementById('user-wallet-input');
            const btn = document.getElementById('verify-btn');
            if (input.value.length < 5) { showToast('Invalid address'); return; }
            const oldText = btn.innerText;
            btn.innerText = 'Verifying...';
            btn.disabled = true;
            setTimeout(() => {
                btn.innerText = oldText;
                btn.disabled = false;
                state.walletVerified = true;
                document.getElementById('manual-step-1').classList.add('hidden');
                document.getElementById('manual-step-2').classList.remove('hidden');
                document.getElementById('manual-step-2').classList.add('fade-in');
            }, 1000);
        }

        function updateLabels() {
            const els = {
                'warn-coin': state.coin,
                'warn-chain': state.chain,
                'summary-chain': state.chain,
                'scan-address-text': state.address,
                'deposit-address': state.address
            };
            for (const [id, val] of Object.entries(els)) {
                const el = document.getElementById(id);
                if(el) el.innerText = val;
            }
        }

        function updateAddress() {
            const qrImg = document.getElementById('qr-image');
            const loader = document.getElementById('qr-loader');
            loader.classList.remove('hidden');
            setTimeout(() => {
                qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${state.address}`;
                qrImg.onload = () => loader.classList.add('hidden');
            }, 200);
            updateLabels();
        }

        function copyAddress() {
            navigator.clipboard.writeText(state.address).then(() => showToast('Copied!'));
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', 'top-16');
            t.classList.add('top-20');
            setTimeout(() => { t.classList.add('opacity-0', 'top-16'); t.classList.remove('top-20'); }, 2000);
        }

        function simulatePayment(instant = false) {
            // Case 1: Manual Crypto Check
            if (!instant && state.mode === 'manual' && !state.walletVerified) {
                showToast('Verify wallet first');
                return;
            }

            // Case 2: Crypto Payment -> Show Pending Info first
            if (state.method === 'crypto' && !instant) {
                const pendingOverlay = document.getElementById('payment-pending-info');
                pendingOverlay.classList.remove('hidden');
                
                // Simulate wait time (e.g. 4 seconds) then show success
                setTimeout(() => {
                    pendingOverlay.classList.add('hidden');
                    document.getElementById('payment-success').classList.remove('hidden');
                }, 4000);
                return;
            }

            // Case 3: Card/Apple Instant Payment
            const processing = document.getElementById('payment-processing');
            processing.classList.remove('hidden');
            setTimeout(() => {
                processing.classList.add('hidden');
                document.getElementById('payment-success').classList.remove('hidden');
            }, 2000);
        }

        function startTimer(duration) {
            let timer = duration;
            const displays = document.querySelectorAll('.timer-display');
            setInterval(() => {
                let m = parseInt(timer / 60, 10);
                let s = parseInt(timer % 60, 10);
                m = m < 10 ? "0" + m : m;
                s = s < 10 ? "0" + s : s;
                displays.forEach(d => d.innerText = m + ":" + s);
                if (--timer < 0) timer = 0;
            }, 1000);
        }
    </script>
</body>
</html>
